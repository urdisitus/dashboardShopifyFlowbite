<div class="mat-elevation-z8">
  <mat-card>
    <mat-form-field style="margin-right: 10px;">
      <input matInput maxlength="20" (keypress)="keyPress($event)" (keyup.enter)="reload()" pattern="[0-9]*"
        inputmode="numeric" placeholder="Número de Orden" [(ngModel)]="listParam.name">
      <button mat-button *ngIf="listParam.name" matSuffix mat-icon-button aria-label="Clear"
        (click)="listParam.name=''">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
    <mat-checkbox class="example-margin" [(ngModel)]="listParam.shippingAddressEmpty" style="margin-right: 10px;">Sin
      Dirección Entrega</mat-checkbox>
    <mat-form-field style="margin-right: 10px;">
      <input matInput [matDatepicker]="startPicker" placeholder="Fecha Inicial" [(ngModel)]="startDate">
      <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
      <mat-datepicker #startPicker></mat-datepicker>
    </mat-form-field>
    <mat-form-field style="margin-right: 10px;">
      <input matInput [matDatepicker]="endPicker" placeholder="Fecha Final" [(ngModel)]="endDate">
      <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
      <mat-datepicker #endPicker></mat-datepicker>
    </mat-form-field>
    <mat-form-field style="margin-right: 10px;">
      <mat-label>Estado</mat-label>
      <mat-select [(value)]="listParam.status">
        <mat-option *ngFor="let item of statusArray" [value]="item.id">{{item.name}}</mat-option>
      </mat-select>
    </mat-form-field>
    <mat-form-field style="margin-right: 10px;">
      <mat-label>Estado de Pago</mat-label>
      <mat-select [(value)]="financialstatusSelected" multiple>
        <mat-option *ngFor="let item of financialstatusArray" [value]="item.id">{{item.name}}</mat-option>
      </mat-select>
    </mat-form-field>
    <mat-form-field style="margin-right: 10px;">
      <mat-label>Estado de Preparación</mat-label>
      <mat-select [(value)]="fulfillmentStatusSelected" multiple>
        <mat-option *ngFor="let item of fulfillmentStatusArray" [value]="item.id">{{item.name}}</mat-option>
      </mat-select>
    </mat-form-field>
    <mat-form-field style="margin-right: 10px;">
      <input matInput maxlength="50" (keyup.enter)="reload()" placeholder="Usuario Vendedor"
        [(ngModel)]="listParam.salesUser">
      <button mat-button *ngIf="listParam.salesUser" matSuffix mat-icon-button aria-label="Clear"
        (click)="listParam.salesUser=''">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
    <button mat-mini-fab color="primary" (click)="reload()" aria-label="Buscar" style="margin-right: 10px;">
      <mat-icon>search</mat-icon>
    </button>
  </mat-card>
</div>
<div class="mat-elevation-z8">
  <div class="table-responsive">
    <div class="container-table">
      <table mat-table [dataSource]="dataSource">
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef> </th>
          <td mat-cell *matCellDef="let element">
            <button mat-button [matMenuTriggerFor]="menu">Acciones</button>
            <mat-menu #menu="matMenu">
              <button mat-menu-item *ngIf="canTracking(element)" (click)="openTracking(trackingModal, element);">Ver
                Seguimiento</button>
              <button mat-menu-item *ngIf="canEditOrder(element)" (click)="showUpdateNitNombre(element);">Datos de
                Facturación</button>
              <button mat-menu-item *ngIf="canEditOrder(element)"
                (click)="showUpdateShippingAddress(element);">Dirección de Entrega</button>
              <button mat-menu-item *ngIf="canGenerateInvoice(element)" (click)="generateInvoice(element);">Generar
                Factura</button>
              <button mat-menu-item *ngIf="canPostVoidInvoice(element)" (click)="postVoidInvoice(element);">Anular
                Factura</button>
              <button mat-menu-item *ngIf="canPostVoidInfo(element)" (click)="postVoiceInfo(element);">Comprobante
                Factura Anulada</button>
              <button mat-menu-item *ngIf="canGetInvoice(element)" (click)="getUrlInvoice(element)">Ver Factura</button>
              <button mat-menu-item *ngIf="canShippingOrder(element)" (click)="shippingOrder(element)">Enviar Entrega
                (Farmamovil)</button>
              <button mat-menu-item *ngIf="canMarkAsDelivered(element)"
                (click)="showMarkAsDelivered(element)">Cambiar estado a Entregado</button>
              <button mat-menu-item *ngIf="canCancelOrder(element)"
                (click)="cancelOrder(element)">Cancelar Orden</button>
              <button mat-menu-item *ngIf="canCancelShippingOrder(element)"
                (click)="cancelShippingOrder(element)">Cancelar Entrega (Farmamovil)</button>
            </mat-menu>
          </td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef> Orden </th>
          <td mat-cell *matCellDef="let element">
            <a href="{{element.orderAdminUrl}}" target="_blank">{{element.name}}</a>
          </td>
        </ng-container>

        <ng-container matColumnDef="invoiceStatus">
          <th mat-header-cell *matHeaderCellDef> Estado Facturación </th>
          <td mat-cell *matCellDef="let element">
            <mat-chip-list *ngIf="getStatusInvoice(element)" aria-label="Estado de Facturación">
              <mat-chip [color]="getStatusInvoiceColor(element)" selected>{{getStatusInvoice(element)}}</mat-chip>
            </mat-chip-list>
          </td>
        </ng-container>

        <ng-container matColumnDef="shippingStatus">
          <th mat-header-cell *matHeaderCellDef> Estado Entrega </th>
          <td mat-cell *matCellDef="let element">
            <mat-chip-list *ngIf="getShippingStatus(element)" aria-label="Estado de Entrega">
              <mat-chip [color]="getShippingStatusColor(element)" selected>{{getShippingStatus(element)}}</mat-chip>
            </mat-chip-list>
          </td>
        </ng-container>

        <ng-container matColumnDef="localidad">
          <th mat-header-cell *matHeaderCellDef> Sucursal </th>
          <td mat-cell *matCellDef="let element">
            <span *ngIf="element.keyBodega">{{element.keyBodega}}/{{element.puntoVentaId}}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="tags">
          <th mat-header-cell *matHeaderCellDef> Etiquetas </th>
          <td mat-cell *matCellDef="let element">
            <mat-chip-list aria-label="Etiquetas">
              <mat-chip *ngFor="let item of element.tags">{{item}}</mat-chip>
            </mat-chip-list>
          </td>
        </ng-container>

        <ng-container matColumnDef="financialStatus">
          <th mat-header-cell *matHeaderCellDef> Estado de Pago </th>
          <td mat-cell *matCellDef="let element; ">
            <mat-chip-list *ngIf="financialstatusDesc(element.financialStatus)" aria-label="Estado de Pago">
              <mat-chip [color]="financialstatusClass(element.financialStatus)" selected>
                {{financialstatusDesc(element.financialStatus)}}</mat-chip>
            </mat-chip-list>
          </td>
        </ng-container>

        <ng-container matColumnDef="fulfillmentStatus">
          <th mat-header-cell *matHeaderCellDef> Estado de Preparación </th>
          <td mat-cell *matCellDef="let element">
            <mat-chip-list *ngIf="fulfillmentStatusDesc(element.fulfillmentStatus)" aria-label="Estado de Preparación">
              <mat-chip [color]="fulfillmentStatusClass(element.fulfillmentStatus)" selected>
                {{fulfillmentStatusDesc(element.fulfillmentStatus)}}</mat-chip>
            </mat-chip-list>
          </td>
        </ng-container>
        <ng-container matColumnDef="invoice">
          <th mat-header-cell *matHeaderCellDef> Datos Facturación </th>
          <td mat-cell *matCellDef="let element">
            <span *ngIf="element.invoiceName"><b>Nombre: </b> {{element.invoiceName}} </span>
            <span *ngIf="element.invoiceNumber"><b>Nit: </b> {{element.invoiceNumber}}</span>
          </td>
        </ng-container>
        <ng-container matColumnDef="shippingAddress">
          <th mat-header-cell *matHeaderCellDef> Dir. Entrega </th>
          <td mat-cell *matCellDef="let element">
            <span *ngIf="element.shippingLatLng"><b>Si</b></span> <span *ngIf="!element.shippingLatLng"><b>No</b></span>
          </td>
        </ng-container>

        <ng-container *ngFor="let item of autoColumns" matColumnDef="{{item.name}}">
          <th mat-header-cell *matHeaderCellDef> {{ item.title}} </th>
          <td mat-cell *matCellDef="let element"> {{element[item.name]}} </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="element-row"></tr>
      </table>
    </div>
  </div>
</div>
<div class="mat-elevation-z8">
  <mat-card>
    <span style="margin-right: 10px;">
      Cantidad de Registros: <b>{{dataSource.data.length}}</b>
    </span>
    <button mat-mini-fab color="primary" [disabled]="!listParam.loadMore" (click)="fetchNext()" aria-label="Siguiente">
      <mat-icon>arrow_forward_ios</mat-icon>
    </button>
  </mat-card>
</div>

<ng-template #trackingModal let-modal>
  <div class="modal-header">
    <h4 class="modal-title" id="modal-basic-title">Seguimiento en linea</h4>
    <button type="button" class="close" aria-label="Close" (click)="modal.dismiss('Cross click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <iframe style="height: 100%;" [src]="trackingUrl | safe" width="100%" height="500px"></iframe>
  </div>
</ng-template>
